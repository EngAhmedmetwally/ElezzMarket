/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset implements a robust Role-Based Access Control (RBAC) system combined with a user-ownership model.
 * Access is primarily determined by a user's role (Admin, Operations, Moderator, Courier) or their direct relationship
 * to a document (e.g., a moderator assigned to an order). The default security posture is to deny all access unless
 * explicitly granted by a rule.
 *
 * ## Data Structure
 * The structure uses dedicated top-level collections for primary entities (users, orders, customers) and for authorization
 * (admins, moderators, etc.). The existence of a document in a role collection (e.g., `/admins/{userId}`) grants that user
 * the corresponding role, which is a highly secure and performant pattern. Subcollections like `/orders/{orderId}/orderItems`
 * are used for nested data, with rules designed to inherit permissions from the parent document.
 *
 * ## Key Security Decisions
 * - **Role-Based Authorization:** Instead of checking a 'role' field on a user profile, we check for the existence of a
 *   document in role-specific collections (e.g., `exists(/databases/$(database)/documents/admins/$(request.auth.uid))`).
 *   This prevents tampering with user profile data to escalate privileges and makes role checks extremely fast.
 * - **User Data Privacy:** Users can only read and write their own profile in `/users/{userId}`. Non-admin users are
 *   explicitly prevented from listing all users in the system.
 * - **Restricted Writes:** Write operations on critical data like commissions or configuration data like roles are
 *   restricted to administrative roles (Admin, Operations) to ensure data integrity, assuming these are often managed by
 *   backend processes.
 *
 * ## Denormalization for Authorization
 * To ensure rules are fast and simple, authorization data is denormalized. For example, an `Order` document contains `moderatorId`
 * and `courierId` fields. Subcollections like `OrderItem` and `OrderFollowUp` are expected to also contain these denormalized
 * IDs (`orderModeratorId`, `orderCourierId`) from their parent order. This avoids slow and costly `get()` calls in rules,
 * allowing for direct permission checks on the document being accessed.
 *
 * ## Structural Segregation
 * Data is segregated by collection, with each top-level collection having a uniform security model. Authorization is handled
 * through the dedicated role collections (`/admins`, `/operations`, etc.), which provides a clear separation between application
 * data and access control data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------------------------------------------------
    // Helper Functions
    // ---------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the document being accessed already exists.
     * Essential for secure update and delete operations.
     */
    function isExistingDoc() {
      return resource != null;
    }



    /**
     * Checks if the requesting user has the 'Admin' role by seeing if a
     * corresponding document exists in the /admins collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /**
     * Checks if the requesting user has the 'Operations' role.
     */
    function isOperations() {
      return isSignedIn() && exists(/databases/$(database)/documents/operations/$(request.auth.uid));
    }

    /**
     * Checks if the requesting user has the 'Moderator' role.
     */
    function isModerator() {
      return isSignedIn() && exists(/databases/$(database)/documents/moderators/$(request.auth.uid));
    }

    /**
     * Checks if the requesting user has the 'Courier' role.
     */
    function isCourier() {
      return isSignedIn() && exists(/databases/$(database)/documents/couriers/$(request.auth.uid));
    }
    
    /**
     * Checks if the requesting user is the moderator or courier assigned to an order.
     * Used for rules on the Order document itself.
     * @param orderData The resource.data map of the order document.
     */
    function isOrderPersonnel(orderData) {
      return isOwner(orderData.moderatorId) || isOwner(orderData.courierId);
    }

    /**
     * Checks if the user is assigned to the parent order of a subcollection document.
     * Used for rules on subcollection documents like OrderItems and OrderFollowUps.
     * @param subcollectionData The resource.data of the subcollection document, which
     *        must contain denormalized IDs from the parent order.
     */
    function isParentOrderPersonnel(subcollectionData) {
      return isOwner(subcollectionData.orderModeratorId) || isOwner(subcollectionData.orderCourierId);
    }
    
    /**
     * Validates that the `id` field of a new user document matches its document ID,
     * ensuring relational integrity from the start.
     */
    function isNewUserDocValid(userId) {
        return request.resource.data.id == userId;
    }

    /**
     * Enforces that the `id` field of a user document cannot be changed after creation.
     */
    function isUserDocIdImmutable() {
        return request.resource.data.id == resource.data.id;
    }

    // ---------------------------------------------------------------------
    // User and Role Collections
    // ---------------------------------------------------------------------

    /**
     * @description Manages user profile data. Users can manage their own profiles.
     *              Admins have full read/write access to all user profiles.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own user document: `auth.uid == 'user123'`, path is `/users/user123`.
     * @deny (list) A non-admin user trying to list all users in the system.
     * @principle Restricts access to a user's own data tree and grants full access to admins.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if true; // Temporarily open for development
      allow create: if isOwner(userId) && isNewUserDocValid(userId);
      allow update: if (isOwner(userId) || isAdmin()) && isExistingDoc() && isUserDocIdImmutable();
      allow delete: if (isOwner(userId) || isAdmin()) && isExistingDoc();
    }

    /**
     * @description System roles. Read-only for authenticated users, writable only by Admins.
     * @path /roles/{roleId}
     * @allow (get) Any signed-in user reading a role definition.
     * @deny (create) A non-admin user trying to create a new role.
     * @principle Enforces admin-only control over critical configuration data.
     */
    match /roles/{roleId} {
      allow read: if true; // Temporarily open for development
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description System permissions. Read-only for authenticated users, writable only by Admins.
     * @path /permissions/{permissionId}
     * @allow (get) Any signed-in user reading a permission definition.
     * @deny (create) A non-admin user trying to create a new permission.
     * @principle Enforces admin-only control over critical configuration data.
     */
    match /permissions/{permissionId} {
      allow read: if true; // Temporarily open for development
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Role collections used for authorization checks. They should not be read directly,
     *              only checked for existence. Writable only by Admins.
     * @path /admins/{userId}, /operations/{userId}, /moderators/{userId}, /couriers/{userId}
     * @allow (create) An Admin adding another user to the 'admins' collection.
     * @deny (get, list) Any user trying to read or list the members of a role group.
     * @principle Prevents enumeration of privileged users and centralizes role management.
     */
    match /admins/{userId} {
      allow get, list: if false;
      allow create, update, delete: if isAdmin();
    }
    match /operations/{userId} {
      allow get, list: if false;
      allow create, update, delete: if isAdmin();
    }
    match /moderators/{userId} {
      allow get, list: if false;
      allow create, update, delete: if isAdmin();
    }
    match /couriers/{userId} {
      allow get, list: if false;
      allow create, update, delete: if isAdmin();
    }


    // ---------------------------------------------------------------------
    // Core Business Logic Collections
    // ---------------------------------------------------------------------

    /**
     * @description Customer data. Writable by Admin/Operations, readable by Moderators.
     * @path /customers/{customerId}
     * @allow (get) A Moderator reading a customer's details to process an order.
     * @deny (update) A Moderator trying to change a customer's address.
     * @principle Segregates duties by granting write access only to management roles.
     */
    match /customers/{customerId} {
      allow read: if true; // Temporarily open for development
      allow create, update, delete: if isAdmin() || isOperations();
    }

    /**
     * @description Product catalog. Writable by Admin/Operations, readable by Moderators.
     * @path /products/{productId}
     * @allow (get) A Moderator reading product details to add to an order.
     * @deny (create) A Moderator trying to add a new product to the catalog.
     * @principle Segregates duties, allowing sales staff to view products but not manage the catalog.
     */
    match /products/{productId} {
      allow read: if true; // Temporarily open for development
      allow create, update, delete: if isAdmin() || isOperations();
    }

    /**
     * @description Sales orders. Accessible to Admins, Operations, and the personnel assigned to the order.
     * @path /orders/{orderId}
     * @allow (get) A Moderator reading an order where `resource.data.moderatorId` matches their own UID.
     * @deny (list) A Moderator attempting a general query on `/orders` without filters. Listing is admin-only.
     * @principle Enforces document ownership for reads/writes via denormalized `moderatorId` and `courierId` fields.
     */
    match /orders/{orderId} {
      allow get: if isAdmin() || isOperations() || (isExistingDoc() && isOrderPersonnel(resource.data));
      allow list: if true; // Temporarily open for development
      allow create: if (isAdmin() || isOperations() || isModerator()) && isOwner(request.resource.data.moderatorId);
      allow update: if (isAdmin() || isOperations() || (isExistingDoc() && isOrderPersonnel(resource.data))) && isExistingDoc();
      allow delete: if (isAdmin() || isOperations()) && isExistingDoc();

      /**
       * @description Line items for an order. Access is inherited from the parent order's assigned personnel.
       * @path /orders/{orderId}/orderItems/{orderItemId}
       * @allow (get) The assigned Courier of the parent order reading the item list.
       * @deny (create) A user trying to add an item to an order they are not the moderator of.
       * @principle Secures subcollection data based on denormalized IDs from the parent document.
       */
      match /orderItems/{orderItemId} {
        allow read: if true;
        allow write: if isSignedIn();
      }
      
      /**
       * @description Tracks follow-up notes on orders. Accessible to order personnel and the note's author.
       * @path /orders/{orderId}/orderFollowUps/{orderFollowUpId}
       * @allow (create) The moderator of an order creating a follow-up note where `request.resource.data.userId` is their own UID.
       * @deny (update) A moderator trying to edit a follow-up note left by another user.
       * @principle Enforces ownership for notes while allowing access to relevant order stakeholders.
       */
      match /orderFollowUps/{orderFollowUpId} {
          allow read: if true;
          allow create: if (isAdmin() || isOperations() || isModerator() || isCourier()) && request.resource.data.userId == request.auth.uid;
          allow update, delete: if (isAdmin() || isOperations() || isOwner(resource.data.userId)) && isExistingDoc();
      }
    }
    
    // ---------------------------------------------------------------------
    // Commission and Reporting Collections
    // ---------------------------------------------------------------------

    /**
     * @description Defines rules for calculating commissions. Writable only by Admin/Operations.
     * @path /commissionRules/{commissionRuleId}
     * @allow (get) An Admin reading a commission rule.
     * @deny (update) Any user other than Admin or Operations trying to modify a rule.
     * @principle Protects sensitive business logic and financial rules from unauthorized changes.
     */
    match /commissionRules/{commissionRuleId} {
      allow read: if true; // Temporarily open for development
      allow create, update, delete: if isAdmin() || isOperations();
    }

    /**
     * @description Records of earned commissions. Users can read their own; writable only by Admin/Operations.
     * @path /commissions/{commissionId}
     * @allow (get) A Moderator reading a commission record where `resource.data.userId` matches their UID.
     * @deny (create) A user trying to create their own commission record.
     * @principle Allows users to view their own earnings while protecting the integrity of financial records.
     */
    match /commissions/{commissionId} {
      allow get: if isAdmin() || isOperations() || (isExistingDoc() && isOwner(resource.data.userId));
      allow list: if isSignedIn();
      allow create, update, delete: if isAdmin() || isOperations();
    }

    /**
     * @description Monthly aggregated commission summaries. Users can read their own; writable only by Admin/Operations.
     * @path /monthlyCommissionSummaries/{monthlyCommissionSummaryId}
     * @allow (get) A Moderator reading their own monthly summary.
     * @deny (list) A user trying to list all commission summaries.
     * @principle Provides personal access to financial summaries while restricting writes to administrative roles.
     */
    match /monthlyCommissionSummaries/{monthlyCommissionSummaryId} {
      allow get: if isAdmin() || isOperations() || (isExistingDoc() && isOwner(resource.data.moderatorId));
      allow list: if isSignedIn();
      allow create, update, delete: if isAdmin() || isOperations();
    }
  }
}
